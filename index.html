<!DOCTYPE html>
<html>

<head>
    <title>Geolocation</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
        html,
        body,
        #map_canvas {
            float: left;
            height: 100%;
            width: 100%;
            margin: 0px;
            padding: 0px;
        }
    </style>
    <div>
        <button id='btn' onclick="_setGeoFire()">儲存目前座標</button>
    </div>
    <script src="https://www.gstatic.com/firebasejs/5.4.1/firebase.js"></script>
    </script>
    <script src='https://cdn.firebase.com/js/client/1.0.17/firebase.js'></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js'></script>
    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyDW09TKNQTWzQSdLXadKUrh4B9ciEpwDB8",
            authDomain: "my-new-project-f39fe.firebaseapp.com",
            databaseURL: "https://my-new-project-f39fe.firebaseio.com",
            projectId: "my-new-project-f39fe",
            storageBucket: "my-new-project-f39fe.appspot.com",
            messagingSenderId: "557151862788",
            appId: "1:557151862788:web:15b30a5b33b3bc08"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
    </script>

</head>

<body>
    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.12.1/firebase.js"></script>
    <script src="https://cdn.firebase.com/libs/geofire/4.1.2/geofire.min.js"></script>
    <script>
        var config = {
            apiKey: "AIzaSyDW09TKNQTWzQSdLXadKUrh4B9ciEpwDB8",
            authDomain: "my-new-project-f39fe.firebaseapp.com",
            databaseURL: "https://my-new-project-f39fe.firebaseio.com",
            projectId: "my-new-project-f39fe",
            storageBucket: "my-new-project-f39fe.appspot.com",
            messagingSenderId: "557151862788"
        };
        firebase.initializeApp(config);
        //Create a node at firebase location to add locations as child keys
        var locationsRef = firebase.database().ref("locations");
        // Create a new GeoFire key under users Firebase location
        var geoFire = new GeoFire(locationsRef.push());
    </script>
    <div id="map_canvas">
        <script>
            function initialize() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function (position) {
                        lat = position.coords.latitude;
                        lng = position.coords.longitude;
                        var pos = { lat: lat, lng: lng };

                        var infowindow = new google.maps.InfoWindow();
                        var map = new google.maps.Map(
                            document.getElementById("map_canvas"), {
                                center: { lat: lat, lng: lng },
                                zoom: 8,
                                mapTypeId: google.maps.MapTypeId.ROADMAP
                            });
                        // Initialize Firebase

                        //_setGeoFire();

                        //Create a node at firebase location to add locations as child keys
                        var locationsRef = firebase.database().ref("locations");
                        var bounds = new google.maps.LatLngBounds();
                        locationsRef.on('child_added', function (snapshot) {
                            var data = snapshot.val();
                            console.log(data);
                            var marker = new google.maps.Marker({
                                position: {
                                    lat: data.User.l[0],
                                    lng: data.User.l[1]
                                },
                                map: map
                            });
                            bounds.extend(marker.getPosition());
                            marker.addListener('click', (function (data) {
                                return function (e) {
                                    infowindow.setContent(this.getPosition().toUrlValue(6) + "<br>");
                                    infowindow.open(map, this);
                                }
                            }(data)));
                            map.fitBounds(bounds);
                        });

                    });
                }
            }
            function _setGeoFire() {
                geoFire.set("User", [lat, lng], Text).then(() => {
                    alert("location added")
                    //console.log("Location added");
                }).catch(function (error) {
                    console.log(error);
                });
            }
            google.maps.event.addDomListener(window, "load", initialize);
        </script>
    </div>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA-noIUiDieN7p6P3eIGRXpWmujZyxwvy0&callback=initMap">
    </script>

</body>

</html>